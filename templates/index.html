<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Lecture Transcript Processor</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Medical Lecture Transcript Processor</h1>
    <input type="file" id="pdfFile" accept="application/pdf, application/vnd.openxmlformats-officedocument.presentationml.presentation" />
    <button id="uploadPdfBtn">Upload PDF</button>
    <br><br>
    <select id="gptModelSelection">
        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
        <option value="gpt-4">GPT-4</option>
        <option value="gpt-4-32k-0613">GPT-4 32K (Not available yet)</option>
    </select>
    <br><br>
    <textarea id="transcript" rows="10" cols="80" placeholder="Enter the lecture transcript"></textarea>
    <br><br>
    <textarea id="gptPrompt" rows="5" cols="80" placeholder="Enter the ChatGPT prompt"></textarea>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <button id="process-btn">Process Transcript</button>
    <button id="practice-questions-btn">Generate Practice Questions</button>  <!-- New Button -->
    <h2>Processed Text:</h2>
    <div id="result"></div>
    <h2>Price:</h2>
    <p id="price"></p>
    <p id="status"></p> 

    <script>

function calculatePrice(model, inputText, outputText) {
    let pricePerInputToken, pricePerOutputToken;
    
    if (model === 'gpt-3.5-turbo') {
        pricePerInputToken = 0.0015 / 1000;
        pricePerOutputToken = 0.002 / 1000;
    } else if (model === 'gpt-4') {
        pricePerInputToken = 0.03 / 1000;
        pricePerOutputToken = 0.06 / 1000;
    } else {  // gpt-4-32k
        pricePerInputToken = 0.06 / 1000;
        pricePerOutputToken = 0.12 / 1000;
    }

    const inputTokens = inputText.split(' ').length;
    const outputTokens = outputText.split(' ').length;
    const price = (inputTokens + outputTokens) * (pricePerInputToken + pricePerOutputToken);

    $('#price').text('$' + price.toFixed(2));
}
        let isRecording = false;

        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const transcriptArea = document.getElementById('transcript');

        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
        recognition.lang = 'en-US';
        recognition.interimResults = true;
        recognition.continuous = true;
        recognition.maxAlternatives = 1;

        let currentTranscript = '';

        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    currentTranscript += event.results[i][0].transcript;
                } else {
                    interimTranscript += event.results[i][0].transcript;
                }
            }
            transcriptArea.value = currentTranscript + interimTranscript;
        };

        recognition.onerror = (event) => {
            console.error('Error in speech recognition:', event.error);
        };

        recognition.onstart = () => {
            startBtn.disabled = true;
            stopBtn.disabled = false;
        };

        recognition.onend = () => {
            if (isRecording) {
                recognition.start();
            } else {
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        };

        startBtn.addEventListener('click', () => {
            isRecording = true;
            recognition.start();
        });

        stopBtn.addEventListener('click', () => {
            isRecording = false;
            recognition.stop();
        });

        $('#process-btn').on('click', function() {
            const transcript = $('#transcript').val();
            const gptPrompt = $('#gptPrompt').val();
            const fullPrompt = gptPrompt + "\n\n" + transcript;
            const selectedModel = $('#gptModelSelection').val();  // Get the selected model from the dropdown

            $.ajax({
                url: '{{ url_for("process_transcript") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({transcript: transcript, gptPrompt: gptPrompt, model: selectedModel}),
                success: function(response) {
                    if (response.error) {
                        alert('Error processing transcript: ' + response.error);
                    } else {
                        $('#result').html(response.processed_text.replace(/\n/g, '<br>'));
                        calculatePrice(selectedModel, fullPrompt, response.processed_text);  // Call function to calculate price
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error processing transcript:', textStatus, errorThrown);
                    alert('Error processing transcript.');
                }
            });
        });

        $('#uploadPdfBtn').on('click', function() {
            const pdfFile = document.getElementById('pdfFile').files[0];
            if (!pdfFile) {
                alert('Please select a PDF file to upload.');
                return;
            }

            const formData = new FormData();
            formData.append('file', pdfFile);

            $.ajax({
                url: '{{ url_for("upload_file") }}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.error) {
                        alert('Error uploading PDF: ' + response.error);
                    } else {
                        $('#transcript').val(response.text);
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error uploading PDF:', textStatus, errorThrown);
                    alert('Error uploading PDF.');
                }
            });
        });


        // New AJAX call for generating practice questions
        $('#practice-questions-btn').on('click', function() {
            const transcript = $('#transcript').val();
	    const selectedModel = $('#gptModelSelection').val(); 

            $.ajax({
                url: '{{ url_for("process_practice_questions") }}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({transcript: transcript, model: selectedModel}),
                success: function(response) {
                    if (response.error) {
                        alert('Error generating practice questions: ' + response.error);
                    } else {
                        const blob = new Blob([response]);
                        const link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = 'generated_pptx.pptx';
                        link.click();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error('Error generating practice questions:', textStatus, errorThrown);
                    alert('Error generating practice questions.');
                }
            });
        });

    </script>
</body>
</html>

